<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Preguntas por Tema</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 1rem;
      background: #f4f4f9;
      color: #333;
      max-width: 800px;
      margin: auto;
    }
    h1 {
      text-align: center;
      color: #2c3e50;
    }
    select, button {
      padding: 0.5rem;
      font-size: 1rem;
      margin: 0.5rem 0;
      width: 100%;
    }
    select {
      background-color: #ecf0f1;
      border: 1px solid #bdc3c7;
      border-radius: 4px;
    }
    .barra {
      height: 20px;
      background: green;
      transition: width 1s linear;
      margin-top: 1rem;
      border-radius: 10px;
    }
    .pregunta, .respuesta {
      background: #ffffff;
      padding: 1rem;
      margin-top: 1rem;
      border-radius: 8px;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
    }
    .oculto {
      display: none;
    }
    #contadorPreguntas {
      margin-top: 1rem;
      font-weight: bold;
      text-align: center;
    }
    .respuesta button {
      background-color: #2ecc71;
      color: white;
      padding: 0.5rem 1rem;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      transition: background-color 0.3s ease;
    }
    .respuesta button:hover {
      background-color: #27ae60;
    }
    .respuestas {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }
    .respuesta-option {
      background-color: #ecf0f1;
      padding: 0.8rem;
      border-radius: 5px;
      text-align: left;
      cursor: pointer;
      transition: background-color 0.3s ease;
    }
    .respuesta-option:hover {
      background-color: #bdc3c7;
    }
  </style>
</head>
<body>
  <h1>Consulta de Preguntas</h1>
  <p id="total"></p>

  <label for="temas">Selecciona hasta 3 temas (usa Ctrl o Cmd):</label>
  <select id="temas" multiple size="5"></select>
  <button id="cargar">Cargar preguntas</button>
  <button id="siguiente" disabled>Ver siguiente pregunta</button>

  <div id="contadorPreguntas" class="oculto"></div>

  <div class="pregunta oculta">
    <h3 id="textoPregunta"></h3>
    <p><strong>Tema:</strong> <span id="temaPregunta"></span></p>
  </div>

  <div class="barra oculta" id="barra"></div>
  <button id="verRespuesta" class="oculto">Ver respuesta</button>
  <div class="respuesta oculta" id="respuesta">
    <div class="respuestas">
      <!-- Respuestas serán cargadas aquí -->
    </div>
  </div>

  <!-- Sonidos -->
  <audio id="audioStart" src="start.mp3" preload="auto"></audio>
  <audio id="audioWarning" src="warning.mp3" preload="auto"></audio>
  <audio id="audioEnd" src="end.mp3" preload="auto"></audio>
  <audio id="audioBackground" src="background.mp3" preload="auto" loop></audio>

  <script>
    const CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vTd4xuQkipHXpfuxm5Zk3nxCdIdpRUxAQcfyQuk2BLPHzNVXgEe-CX6PR4D_ueCWFvcGDSrGvTrlyRt/pub?output=csv";
    let datos = [];
    let preguntasSeleccionadas = [];
    let preguntaActual = 0;
    let timer, tiempo = 58;

    // Cargar datos CSV
    fetch(CSV_URL)
      .then(res => res.text())
      .then(data => {
        const filas = data.trim().split('\n');
        datos = filas.map(f => f.split(',')).filter(f => f.length >= 6);

        document.getElementById("total").innerText = `Total de preguntas: ${datos.length}`;

        const temasUnicos = [...new Set(datos.map(f => f[5].trim()))];
        const selector = document.getElementById("temas");
        temasUnicos.forEach(t => {
          const opt = document.createElement("option");
          opt.value = t;
          opt.innerText = t;
          selector.appendChild(opt);
        });
      });

    // Cargar preguntas al hacer clic en "Cargar preguntas"
    document.getElementById("cargar").addEventListener("click", () => {
      const seleccionados = Array.from(document.getElementById("temas").selectedOptions).map(o => o.value);
      if (seleccionados.length === 0 || seleccionados.length > 3) {
        alert("Selecciona entre 1 y 3 temas.");
        return;
      }

      preguntasSeleccionadas = [];
      seleccionados.forEach(t => {
        const delTema = datos.filter(f => f[5].trim() === t);
        const mezcladas = delTema.sort(() => 0.5 - Math.random()).slice(0, 15);
        preguntasSeleccionadas.push(...mezcladas);
      });

      preguntasSeleccionadas = preguntasSeleccionadas.sort(() => 0.5 - Math.random());
      preguntaActual = 0;
      document.getElementById("siguiente").disabled = false;
      document.getElementById("contadorPreguntas").classList.remove("oculto");
      mostrarPregunta();
    });

    // Ver siguiente pregunta
    document.getElementById("siguiente").addEventListener("click", mostrarPregunta);

    function mostrarPregunta() {
      if (preguntaActual >= preguntasSeleccionadas.length) {
        alert("No hay más preguntas");
        return;
      }

      const [pregunta, respuestaCorrecta, tema, , , ] = preguntasSeleccionadas[preguntaActual];
      document.getElementById("textoPregunta").innerText = pregunta;
      document.getElementById("temaPregunta").innerText = tema;
      document.querySelector(".pregunta").classList.remove("oculto");
      document.getElementById("respuesta").classList.add("oculto");
      document.getElementById("verRespuesta").classList.remove("oculto");

      document.getElementById("contadorPreguntas").innerText = `Preguntas restantes: ${preguntasSeleccionadas.length - preguntaActual - 1}`;
      cargarRespuestas(respuestaCorrecta);
      iniciarBarra(respuestaCorrecta);
      preguntaActual++;
    }

    function cargarRespuestas(respuestaCorrecta) {
      const respuestas = ["Respuesta Correcta", "Respuesta Incorrecta 1", "Respuesta Incorrecta 2", "Respuesta Incorrecta 3"];
      const respuestasElement = document.querySelector(".respuestas");
      respuestasElement.innerHTML = "";

      respuestas.sort(() => Math.random() - 0.5).forEach((respuesta, i) => {
        const div = document.createElement("div");
        div.classList.add("respuesta-option");
        div.innerText = respuesta;
        respuestasElement.appendChild(div);
      });
    }

    function iniciarBarra(respuesta) {
      let segundos = tiempo;
      const barra = document.getElementById("barra");
      barra.classList.remove("oculto");
      barra.style.width = "100%";
      barra.style.background = "green";

      const audioBackground = document.getElementById("audioBackground");
      audioBackground.currentTime = 0;
      audioBackground.volume = 1;
      audioBackground.play();

      const audioStart = document.getElementById("audioStart");
      audioStart.currentTime = 0;
      audioStart.play();

      timer = setInterval(() => {
        segundos--;
        barra.style.width = `${(segundos / tiempo) * 100}%`;
        if (segundos <= 20) barra.style.background = "orange";
        if (segundos <= 10) barra.style.background = "red";
        if (segundos <= 0) {
          clearInterval(timer);
          barra.classList.add("oculto");
          document.getElementById("respuesta").innerText = respuesta;
          document.getElementById("respuesta").classList.remove("oculto");
          document.getElementById("verRespuesta").classList.add("oculto");
          audioBackground.pause();
        }
      }, 1000);

      document.getElementById("verRespuesta").onclick = () => {
        clearInterval(timer);
        barra.classList.add("oculto");
        document.getElementById("respuesta").innerText = respuesta;
        document.getElementById("respuesta").classList.remove("oculto");
        document.getElementById("verRespuesta").classList.add("oculto");
        audioBackground.pause();
      };
    }
  </script>
</body>
</html>
