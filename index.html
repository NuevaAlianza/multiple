<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Quiz Bíblico</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: linear-gradient(to bottom, #f2f2f2, #e6e6e6);
      padding: 1rem;
      max-width: 600px;
      margin: auto;
    }

    h1 {
      text-align: center;
    }

    select, button {
      padding: 0.6rem;
      font-size: 1rem;
      width: 100%;
      margin-top: 0.5rem;
    }

    .barra {
      height: 20px;
      background: green;
      margin: 1rem 0;
      transition: width 1s linear, background-color 0.5s;
    }

    .pregunta {
      background: #fff;
      padding: 1rem;
      border-radius: 10px;
      margin-top: 1rem;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
    }

    .opciones {
      margin-top: 1rem;
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
    }

    .opcion {
      background: #eee;
      padding: 0.7rem;
      border-radius: 8px;
      cursor: pointer;
      text-align: center;
      font-weight: bold;
    }

    .correcta {
      background: #c8e6c9 !important;
    }

    .incorrecta {
      background: #ffcdd2 !important;
    }

    .oculto {
      display: none;
    }

    #contadorPreguntas {
      text-align: center;
      font-weight: bold;
      margin-top: 1rem;
    }

    @media (max-width: 600px) {
      body {
        padding: 0.5rem;
      }
    }
  </style>
</head>
<body>
  <h1>Quiz Bíblico</h1>

  <label for="temas">Selecciona hasta 3 temas:</label>
  <select id="temas" multiple size="5"></select>
  <button id="cargar">Cargar preguntas</button>
  <button id="siguiente" disabled>Ver siguiente pregunta</button>

  <div id="contadorPreguntas" class="oculto"></div>

  <div class="pregunta oculto">
    <h3 id="textoPregunta"></h3>
    <p><strong>Tema:</strong> <span id="temaPregunta"></span></p>
    <div id="barra" class="barra oculto"></div>
    <div id="opciones" class="opciones"></div>
  </div>

  <audio id="audioStart" src="start.mp3" preload="auto"></audio>
  <audio id="audioBackground" src="background.mp3" preload="auto" loop></audio>
  <audio id="audioEnd" src="end.mp3" preload="auto"></audio>

  <script>
    const CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vTd4xuQkipHXpfuxm5Zk3nxCdIdpRUxAQcfyQuk2BLPHzNVXgEe-CX6PR4D_ueCWFvcGDSrGvTrlyRt/pub?output=csv";
    let datos = [], preguntasSeleccionadas = [], preguntaActual = 0;
    let tiempo = 58, timer;

    fetch(CSV_URL)
      .then(res => res.text())
      .then(texto => {
        const filas = texto.trim().split("\n").map(f => f.split(","));
        datos = filas.filter(f => f.length >= 7); // mínimo 7 columnas

        const temasUnicos = [...new Set(datos.map(f => f[6].trim()))];
        const selector = document.getElementById("temas");
        temasUnicos.forEach(t => {
          const opt = document.createElement("option");
          opt.value = t;
          opt.textContent = t;
          selector.appendChild(opt);
        });
      });

    document.getElementById("cargar").addEventListener("click", () => {
      const seleccionados = Array.from(document.getElementById("temas").selectedOptions).map(o => o.value);
      if (seleccionados.length === 0 || seleccionados.length > 3) {
        alert("Selecciona entre 1 y 3 temas.");
        return;
      }

      preguntasSeleccionadas = [];
      seleccionados.forEach(t => {
        const delTema = datos.filter(f => f[6].trim() === t);
        const mezcladas = delTema.sort(() => 0.5 - Math.random()).slice(0, 15);
        preguntasSeleccionadas.push(...mezcladas);
      });

      preguntasSeleccionadas = preguntasSeleccionadas.sort(() => 0.5 - Math.random());
      preguntaActual = 0;

      document.getElementById("siguiente").disabled = false;
      document.getElementById("contadorPreguntas").classList.remove("oculto");

      mostrarPregunta();
    });

    document.getElementById("siguiente").addEventListener("click", mostrarPregunta);

    function mostrarPregunta() {
      if (preguntaActual >= preguntasSeleccionadas.length) {
        alert("Fin de las preguntas.");
        return;
      }

      const [pregunta, correcta, , inc1, inc2, inc3, tema] = preguntasSeleccionadas[preguntaActual];
      const opciones = [correcta, inc1, inc2, inc3].sort(() => 0.5 - Math.random());

      document.getElementById("textoPregunta").textContent = pregunta;
      document.getElementById("temaPregunta").textContent = tema;
      document.querySelector(".pregunta").classList.remove("oculto");

      const contenedor = document.getElementById("opciones");
      contenedor.innerHTML = "";

      opciones.forEach(op => {
        const btn = document.createElement("div");
        btn.className = "opcion";
        btn.textContent = op;
        btn.onclick = () => {
          detenerTiempo();
          marcarRespuestas(op, correcta);
        };
        contenedor.appendChild(btn);
      });

      document.getElementById("contadorPreguntas").textContent =
        `Preguntas restantes: ${preguntasSeleccionadas.length - preguntaActual - 1}`;

      iniciarBarra(correcta);
      preguntaActual++;
    }

    function marcarRespuestas(seleccionada, correcta) {
      const botones = document.querySelectorAll(".opcion");
      botones.forEach(b => {
        if (b.textContent === correcta) {
          b.classList.add("correcta");
        } else {
          b.classList.add("incorrecta");
        }
        b.onclick = null;
      });
    }

    function iniciarBarra(correcta) {
      const barra = document.getElementById("barra");
      barra.classList.remove("oculto");
      barra.style.width = "100%";
      barra.style.background = "green";

      // Sonido de inicio y fondo
      const audioStart = document.getElementById("audioStart");
      const audioBg = document.getElementById("audioBackground");
      audioStart.currentTime = 0;
      audioStart.play();
      audioBg.currentTime = 0;
      audioBg.volume = 0.3;
      audioBg.play();

      let segundos = tiempo;
      timer = setInterval(() => {
        segundos--;
        barra.style.width = `${(segundos / tiempo) * 100}%`;

        if (segundos <= 10) barra.style.background = "red";
        else if (segundos <= 20) barra.style.background = "orange";

        if (segundos <= 0) {
          detenerTiempo();
          marcarRespuestas("", correcta);
        }
      }, 1000);
    }

    function detenerTiempo() {
      clearInterval(timer);
      document.getElementById("barra").classList.add("oculto");
      document.getElementById("audioBackground").pause();
      document.getElementById("audioEnd").play();
    }
  </script>
</body>
</html>

